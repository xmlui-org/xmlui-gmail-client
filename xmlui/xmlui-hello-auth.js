(function(_,x){typeof exports=="object"&&typeof module<"u"?module.exports=x(require("react/jsx-runtime"),require("xmlui"),require("react")):typeof define=="function"&&define.amd?define(["react/jsx-runtime","xmlui","react"],x):(_=typeof globalThis<"u"?globalThis:_||self,_["xmlui-hello-auth"]=x(_.jsxRuntime,_.xmlui,_.React))})(this,(function(_,x,l){"use strict";function G(i){try{const o=i.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),s=atob(o);return JSON.parse(s)}catch(o){return console.warn("Failed to parse ID token",o),null}}function N(i){const o=i.length%4?4-i.length%4:0,s=i.replace(/-/g,"+").replace(/_/g,"/")+"=".repeat(o),h=atob(s),r=new Uint8Array(h.length);for(let g=0;g<h.length;g++)r[g]=h.charCodeAt(g);return JSON.parse(new TextDecoder().decode(r))}function Q(i){const[o,s]=i.split(".");return{header:N(o),payload:N(s)}}function Y(i){return i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength)}async function Z(i){const o=Y(i),s=await crypto.subtle.digest("SHA-256",o);return new Uint8Array(s)}function R(i){let o="";for(let h=0;h<i.length;h++)o+=String.fromCharCode(i[h]);return btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function V(i){return new TextEncoder().encode(i)}function L(i=32){const o=new Uint8Array(i);return crypto.getRandomValues(o),R(o)}async function ee(){const i=L(32),o=await Z(V(i)),s=R(o);return{verifier:i,challenge:s}}function O(i){return i==="local"?window.localStorage:window.sessionStorage}const A={scopes:"openid email profile",storage:"session",autoLogin:!1,debug:!0},te=l.forwardRef(function({issuer:o,client_id:s,client_secret:h,redirect_uri:r,scopes:g=A.scopes,storage:m=A.storage,autoLogin:E=A.autoLogin,debug:a=A.debug,proxy_base_url:H,authorize_params:q,registerComponentApi:B,updateState:ne},ge){const[se]=l.useState("idle"),[ie,re]=l.useState(void 0),[f,D]=l.useState(void 0),[ae,k]=l.useState(void 0),[b,I]=l.useState(void 0),[S,P]=l.useState(void 0),[ce,U]=l.useState(void 0),[le,T]=l.useState(void 0),[de,C]=l.useState(void 0),[F,ue]=l.useState(!1),y=l.useMemo(()=>`xmlui.auth:${o||"unknown"}:${s||"unknown"}`,[o,s]),$=l.useMemo(()=>{if(!q)return;const t={};return Object.entries(q).forEach(([e,n])=>{n!=null&&(t[e]=typeof n=="string"?n:String(n))}),Object.keys(t).length?t:void 0},[q]),pe=l.useMemo(()=>({issuer:o,client_id:s,client_secret:h,redirect_uri:r,scopes:g,storage:m,autoLogin:E,proxy_base_url:H,authorize_params:$}),[o,s,h,r,g,m,E,H,$]),j=l.useMemo(()=>{if(typeof window>"u"||!o)return{matched:!1,params:void 0};try{const t=new URL(window.location.href),e=t.searchParams.get("iss");if(e&&e===o){const n=t.searchParams.get("domain_hint")||void 0,c={};return n&&(c.domain_hint=n),{matched:!0,params:c}}}catch(t){a&&console.warn("[HelloAuth] provider init parse error",t)}return{matched:!1,params:void 0}},[o,a]);function w(){const t={status:se,echo:pe,endpoints:f,error:ae,temp:b,tokens:S,claims:ce,user:le,expiresAt:de,lastPokeAt:ie};a&&console.debug("[HelloAuth] publish →",t),ne?.(t)}l.useEffect(()=>{if(typeof window>"u")return;const t=O(m);try{const e=t.getItem(`${y}:session`);if(!e)return;const n=JSON.parse(e);a&&console.debug("[HelloAuth] Hydrating from session storage",n);const c=n.expires_at??n.expiresat;if(c){const p=Date.now(),u=300*1e3;if(p+u>=c){a&&console.warn("[HelloAuth] Session expired or expires soon, clearing storage");try{t.removeItem(`${y}:session`),t.removeItem(y)}catch{}return}}n.tokens&&P(n.tokens),n.claims&&U(n.claims),n.user&&T(n.user),c&&C(c),setTimeout(()=>w(),0)}catch(e){a&&console.warn("[HelloAuth] Failed to hydrate session",e)}},[y,m]),l.useEffect(()=>{try{const t=new URL(window.location.href),e=t.searchParams,n=e.get("code"),c=e.get("state");if(!n)return;const u=O(m).getItem(y),d=u?JSON.parse(u):void 0;if(!d||!d.state||c!==d.state){a&&console.warn("[HelloAuth] callback: state mismatch or missing stash"),k({code:"redirect_state_mismatch",message:"State returned by the provider does not match the stored state.",details:{returnedState:c,expectedState:d?.state}}),I(void 0),t.search="",window.history.replaceState({},document.title,t.toString()),setTimeout(w,0);return}k(void 0),I({code_verifier:d.code_verifier,state:d.state,nonce:d.nonce,code:n}),a&&console.debug("[HelloAuth] callback ✓ code captured"),t.search="",window.history.replaceState({},document.title,t.toString()),setTimeout(w,0)}catch(t){a&&console.warn("[HelloAuth] callback error",t)}},[y,m,a]),l.useEffect(()=>{(async()=>{if(!(!b?.code||!f?.token_endpoint||!s||!r))try{const t=H?.replace(/\/+$/,""),e=f.token_endpoint.replace(/^https?:\/\//,""),n=t?`${t}/${e}`:f.token_endpoint,c=new URLSearchParams({grant_type:"authorization_code",code:b.code,client_id:s,redirect_uri:r,code_verifier:b.code_verifier||""});h&&(c.append("client_secret",h),a&&console.warn("[HelloAuth] ⚠️ Using client_secret (INSECURE for production!)")),a&&(console.debug("[HelloAuth] token POST →",n),console.debug("[HelloAuth] token body →",Object.fromEntries(c.entries())));const p=await fetch(n,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:c});if(!p.ok){const v=await p.text().catch(()=>"");throw new Error(`HTTP ${p.status} ${p.statusText} :: ${v}`)}const u=await p.json();if(P(u),u.id_token){const v=G(u.id_token);v&&T({sub:v.sub,email:v.email,name:v.name,picture:v.picture})}k(void 0),a&&console.debug("[HelloAuth] token ✓",u);const d=O(m);try{d.removeItem(y)}catch{}setTimeout(w,0)}catch(t){const e=String(t?.message||t),n={code:e.includes("CORS")?"cors_blocked":"token_exchange_failed",message:"Failed to exchange authorization code for tokens",details:e};a&&console.warn("[HelloAuth] token ✗",n),P(void 0),k(n),setTimeout(w,0)}})()},[b?.code,f?.token_endpoint,s,h,r,H]),l.useEffect(()=>{(async()=>{if(S?.id_token)try{const{header:t,payload:e}=Q(S.id_token);if(a&&(console.debug("[HelloAuth] id_token header/payload",t,e),console.info("[HelloAuth] login claims",{sub:e.sub,email:e.email,iss:e.iss})),f?.issuer&&e.iss!==f.issuer)throw new Error(`iss mismatch: ${e.iss} !== ${f.issuer}`);if(s&&!(Array.isArray(e.aud)?e.aud.includes(s):e.aud===s))throw new Error("aud mismatch");const n=Math.floor(Date.now()/1e3);if(e.exp&&e.exp<=n)throw new Error(`id_token expired: exp=${e.exp}, now=${n}`);if(b?.nonce&&e.nonce&&e.nonce!==b.nonce)throw new Error("nonce mismatch");const c={sub:e.sub,email:e.email,name:e.name||e.preferred_username||[e.given_name,e.family_name].filter(Boolean).join(" ")||void 0,picture:e.picture},p=typeof S.expires_in=="number"?Date.now()+S.expires_in*1e3:e.exp?e.exp*1e3:void 0;U(e),T(c),C(p),k(void 0);const u=O(m);try{u.setItem(`${y}:session`,JSON.stringify({tokens:S,claims:e,user:c,expires_at:p}))}catch{}setTimeout(w,0)}catch(t){const e={code:"unknown",message:"ID token claim verification failed",details:String(t?.message||t)};a&&console.warn("[HelloAuth] verify ✗",e),k(e),U(void 0),T(void 0),C(void 0),setTimeout(w,0)}})()},[S?.id_token,f?.issuer,s,b?.nonce,y,m,a]);const J=l.useRef(null);l.useEffect(()=>{if(D(void 0),k(void 0),!o){w();return}const e=`${o.replace(/\/+$/,"")}/.well-known/openid-configuration`,n=H?.replace(/\/+$/,"")||void 0,c=e.replace(/^https?:\/\//,""),p=n?`${n}/${c}`:e;J.current?.abort(),J.current=new AbortController,(async()=>{try{a&&console.debug("[HelloAuth] discovery →",p);const u=await fetch(p,{signal:J.current.signal});if(!u.ok)throw new Error(`HTTP ${u.status}`);const d=await u.json(),v={issuer:d.issuer,authorization_endpoint:d.authorization_endpoint,token_endpoint:d.token_endpoint,jwks_uri:d.jwks_uri,userinfo_endpoint:d.userinfo_endpoint,end_session_endpoint:d.end_session_endpoint||d.end_session_endpoint_url};a&&console.debug("[HelloAuth] discovery ✓",v),D(v),k(void 0),setTimeout(w,0)}catch(u){if(u?.name==="AbortError")return;const d={code:"discovery_failed",message:"Failed to load OIDC discovery document",details:String(u?.message||u)};a&&console.warn("[HelloAuth] discovery ✗",d),D(void 0),k(d),setTimeout(w,0)}})()},[o,H]);const z=l.useCallback(async t=>{if(!f?.authorization_endpoint||!s||!r){a&&console.warn("[HelloAuth] login(): missing config"),k({code:"config_missing",message:"issuer/client_id/redirect_uri or endpoints are missing"}),setTimeout(w,0);return}if(!window.crypto?.subtle){k({code:"unknown",message:"Web Crypto not available"}),setTimeout(w,0);return}const{verifier:e,challenge:n}=await ee(),c=L(16),p=L(16),u=O(m),d={code_verifier:e,state:c,nonce:p,redirect_uri:r,client_id:s};u.setItem(y,JSON.stringify(d));const v=new URL(f.authorization_endpoint),W=new URLSearchParams({response_type:"code",client_id:s,redirect_uri:r,scope:g||"openid",state:c,nonce:p,code_challenge:n,code_challenge_method:"S256"}),fe={...$||{},...t||{}};Object.entries(fe).forEach(([he,M])=>{M!=null&&W.set(he,M)}),v.search=W.toString();const X=v.toString();a&&console.debug("[HelloAuth] built authorize URL:",X),I({code_verifier:e,state:c,nonce:p}),setTimeout(w,0),window.location.assign(X)},[f?.authorization_endpoint,s,r,g,m,y,a,$]),K=l.useCallback(async()=>{a&&console.debug("[HelloAuth] logout()"),P(void 0),U(void 0),T(void 0),C(void 0),k(void 0),I(void 0);const t=O(m);try{t.removeItem(y),t.removeItem(`${y}:session`)}catch{}if(f?.end_session_endpoint&&S?.id_token){const e=new URL(f.end_session_endpoint),n=new URLSearchParams({id_token_hint:S.id_token,post_logout_redirect_uri:r||window.location.origin});e.search=n.toString();const c=e.toString();a&&console.debug("[HelloAuth] logout redirect →",c),window.location.assign(c)}else setTimeout(w,0)},[a,m,y,f?.end_session_endpoint,S?.id_token,r]);return l.useEffect(()=>{B?.({poke:()=>{const e=new Date().toISOString();a&&console.debug("[HelloAuth] poke()",e),re(e),setTimeout(w,0)},login:z,logout:K})},[B,z,K,a]),l.useEffect(()=>{F||!(E||j.matched)||!f?.authorization_endpoint||!s||!r||(z(j.params),ue(!0))},[E,j.matched,j.params,F,f?.authorization_endpoint,s,r,z]),null}),oe=x.createMetadata({description:"`HelloAuth` is a headless auth service (no UI).",status:"experimental",props:{issuer:{description:"OIDC issuer.",type:"string",isRequired:!1},client_id:{description:"OIDC client id.",type:"string",isRequired:!1},client_secret:{description:"OAuth client secret (INSECURE for browser apps!).",type:"string",isRequired:!1},redirect_uri:{description:"Redirect URI.",type:"string",isRequired:!1},scopes:{description:"Scopes (space-separated).",type:"string",isRequired:!1,defaultValue:A.scopes},storage:{description:"session | local",type:"string",isRequired:!1,defaultValue:A.storage},autoLogin:{description:"Attempt start on mount.",type:"boolean",isRequired:!1,defaultValue:A.autoLogin},debug:{description:"Console debug.",type:"boolean",isRequired:!1,defaultValue:A.debug},proxy_base_url:{description:"Optional proxy base, e.g. 'http://localhost:8080/proxy/'. If present, discovery and (later) token calls go through it.",type:"string",isRequired:!1},authorize_params:{description:"Optional object of extra query params to append to the /authorize redirect (e.g. { domain_hint: 'nsoftware.com' }).",type:"object",isRequired:!1},id:{description:"Component id.",type:"string",isRequired:!1}},events:{},apis:{poke:{description:"Update lastPokeAt in state.",type:"function"},login:{description:"Start OIDC Authorization Code + PKCE redirect.",type:"function"},logout:{description:"Clear auth state and optionally redirect to end session endpoint.",type:"function"}}});return{namespace:"XMLUIExtensions",components:[x.createComponentRenderer("HelloAuth",oe,({node:i,extractValue:o,registerComponentApi:s,updateState:h})=>{const r=i.props,g=o(r?.authorize_params),m=g&&typeof g=="object"&&!Array.isArray(g)?g:void 0;return _.jsx(te,{id:o.asOptionalString(r?.id),issuer:o.asOptionalString(r?.issuer),client_id:o.asOptionalString(r?.client_id),client_secret:o.asOptionalString(r?.client_secret),redirect_uri:o.asOptionalString(r?.redirect_uri),scopes:o.asOptionalString(r?.scopes),storage:o.asOptionalString(r?.storage),autoLogin:o.asOptionalBoolean(r?.autoLogin),debug:o.asOptionalBoolean(r?.debug),proxy_base_url:o.asOptionalString(r?.proxy_base_url),authorize_params:m,registerComponentApi:s,updateState:h})})]}}));typeof window.xmlui<"u"&&window.xmlui.standalone.registerExtension(window["xmlui-hello-auth"].default||window["xmlui-hello-auth"]);
